name: Infrastructure Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/k8s/**'
      - '.github/workflows/infrastructure-deploy.yml'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ secrets.AKS_CLUSTER_NAME }} \
          --admin

    - name: Deploy backend infrastructure
      run: |
        cd backend/k8s
        kubectl apply -f namespace.yaml
        kubectl apply -f secret.yaml
        kubectl apply -f configmap.yaml
        kubectl apply -f auth-deployment.yaml
        kubectl apply -f events-deployment.yaml
        kubectl apply -f projects-deployment.yaml
        kubectl apply -f participants-deployment.yaml
        kubectl apply -f notifications-deployment.yaml
        kubectl apply -f gateway-deployment.yaml
        kubectl apply -f ingress.yaml

    - name: Deploy frontend infrastructure
      run: |
        cd backend/k8s
        kubectl apply -f frontend-namespace.yaml
        kubectl apply -f frontend-deployment.yaml
        kubectl apply -f frontend-ingress.yaml

    - name: Verify deployments
      run: |
        kubectl get pods -n backend
        kubectl get pods -n frontend
        kubectl get ingress -n backend
        kubectl get ingress -n frontend
